image: node:latest

stages:
  - build
  - lint
  - test
  - deploy

cache:
  paths:
    - node_modules/

build:
  stage: build
  script:
    - yarn
    - yarn build-prod
  artifacts:
    paths:
    - dist_preprod
    - dist_prod

lint:
  stage: lint
  script:
    - yarn lint
  when: manual

stylelint:
  stage: lint
  script:
    - yarn stylelint
  when: manual

test:
  stage: test
  script:
    - yarn test-cover
  when: manual

deploy:
  stage: deploy
  image:
    name: hashicorp/terraform:light
    entrypoint:
      - '/usr/bin/env'
      - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'  
  # variables:
  #   secrets_storage_name: ${secrets_storage_name}
  #   secrets_storage_value: ${secrets_storage_value}
  #   jwt_secret: ${jwt_secret}
  script:
  # - export secrets_storage_name=${secrets_storage_name}
  # - export secrets_storage_value=${secrets_storage_value}
  # - export jwt_secret=${jwt_secret}
  - cd terraform
  - terraform apply
